!function(e,t){function o(){this.init()}var d,p;t.comment=(d=e,(p=t).modules,p.npm.objectAssign(o.prototype,{init:function(){this.ajax={},d(d.proxy(function(){var e=(window.location.hash||"").match(/[#&]comment(?:\.|=)(\d+)\.(\d+)(?:\.(\d+)(?:\.(\d+))?)?/);e&&e[2]&&this.whenLoaded(e[1]).done(d.proxy(function(){this.reveal(e[1],e[2],e[3],e[4])},this))},this)),p.observer.addAction("post_loaded",function(e){var t=d(e),o=t.find("textarea[name=comment]");o.ps_autosize(),o.each(function(){var t=this;p.elements.droppable(t,{dropped:function(e){p.observer.doAction("commentbox_drop_files",t,e)}})}),t.on("click",".ps-comment-time .activity-post-age",function(e){d(e.currentTarget).children("a").each(function(){var e,t,o=d(this);o.children(".ps-js-autotime").length&&(e=o.attr("href"),t=location.href.replace(location.hash,""),0===e.indexOf(t)&&(window.location=e,window.location.reload()))})})},10,1)},whenLoaded:function(n){return d.Deferred(function(e){var t=0,o=setInterval(function(){d(".ps-js-activity--"+n).length?(clearInterval(o),e.resolve()):60<t++&&(clearInterval(o),e.reject())},1e3)})},add:function(){},edit:function(){},reply:function(e,t,o,n){var i,s="#comment-item-"+t,r=o?d(o).closest(s):d(s),c=r.find(".actaction-reply"),a=c.closest(".ps-comments").hasClass("ps-comments--nested")?(i=c.closest(".ps-comments").children(".ps-comment-reply")).find("textarea"):(i=c.closest(".ps-comment").next(".ps-comments--nested").children(".ps-comment-reply")).find("textarea");i.not(":visible")&&i.show(),a.focus(),n=n||{},p.observer.applyFilters("comment.reply",a,d.extend({},n,{act_id:e,post_id:t})),a.off("keyup.peepso").on("keyup.peepso",function(e){e.stopPropagation(),activity.update_beautifier(e.target)}).trigger("keyup.peepso")},show_previous:function(t,e){var r,c,a,o=".ps-js-comment-container--"+t;return r=e?d(e).closest(o):d(o),c=r.find(".ps-js-comment-more").eq(0),a=c.find(".ps-js-loading"),d.Deferred(function(e){var i,s;i=function(){e.resolve()},s=r.children(".cstream-comment:first"),a.show(),p.postJson("activity.show_previous_comments",{act_id:t,uid:peepsodata.currentuserid,first:s.data("comment-id")},function(e){var t=jQuery("<div />").append(e.data.html),t=p.observer.applyFilters("peepso_activity",t),o=(o=p.observer.applyFilters("peepso_activity_content",t.html())).replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"'),n=d(o);a.hide(),0==s.length?(s=r.children(".ps-comment-more")).after(n):s.before(n),n.each(function(){1===this.nodeType&&d(this).hasClass("ps-js-comment-item")&&p.hooks.doAction("comment_added",this)}),0<e.data.comments_remain?c.find("a").html(e.data.comments_remain_caption):c.remove(),d(document).trigger("ps_comment_added"),i()})})},show_all:function(t){var c=d(".ps-js-comment-container--"+t),a=c.children(".ps-js-comment-more"),m=a.find(".ps-js-loading");return d.Deferred(function(e){!function i(s){var r=c.children(".cstream-comment:first");m.removeClass("hidden"),p.postJson("activity.show_previous_comments",{act_id:t,uid:peepsodata.currentuserid,all:1,first:r.data("comment-id")},function(e){var t=jQuery("<div />").append(e.data.html),t=p.observer.applyFilters("peepso_activity",t),o=(o=p.observer.applyFilters("peepso_activity_content",t.html())).replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"'),n=d(o);m.addClass("hidden"),0==r.length?(r=c.children(".ps-comment-more")).after(n):r.before(n),n.each(function(){1===this.nodeType&&d(this).hasClass("ps-js-comment-item")&&p.hooks.doAction("comment_added",this)}),0<e.data.comments_remain?(a.find("a").html(e.data.comments_remain_caption),i(s)):(a.remove(),d(document).trigger("ps_comment_added"),s())})}(function(){e.resolve()})})},reveal_comment:function(t,o){return d.Deferred(d.proxy(function(e){d("#comment-item-"+o).length?e.resolve():this.show_all(t).done(d.proxy(function(){e.resolve()},this))},this))},reveal:function(e,t,o,n){function i(e){var t=e.find("a.ps-comment-user").eq(0).css("color"),o=e.offset().top-(d(window).height()-e.outerHeight())/2;e.css({backgroundColor:t}),e.css({transition:"background-color 2s ease"}),d("html, body").delay(50).animate({scrollTop:o},500,function(){e.css({backgroundColor:""})})}this.reveal_comment(e,t).done(d.proxy(function(){n?this.reveal_comment(o,n).done(function(){i(d("#comment-item-"+n))}):i(d("#comment-item-"+t))},this))}}),new o)}(jQuery,peepso);