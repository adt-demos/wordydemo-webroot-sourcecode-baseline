!function(t){var e,n,i,a,r,d,l,h,s=(e="PsActivityStream",n=t,t=peepso.observer,peepso.modules,i="scroll.ps-activity-stream",a=+peepsodata.is_admin,r=+peepsodata.currentuserid,d=+peepsodata.userid,l=n("#peepso_post_id").val()||void 0,h=n("#peepso_context").val()||void 0,function(t,e){function i(){t.clientWidth<700?t.classList.add("ps-activity--narrow"):t.classList.remove("ps-activity--narrow")}t&&(i(),e.addAction("browser.resize",i))}(document.querySelector(".ps-activity"),t),peepso.createClass(e,{__constructor:function(t,e){this.$el=n(t),this.$recent=n("#ps-activitystream-recent"),this.$loading=n("#ps-activitystream-loading"),this.$noPosts=n("#ps-no-posts"),this.$noPostsMatch=n("#ps-no-posts-match"),this.$noMorePosts=n("#ps-no-more-posts"),this.$filters=n(".ps-js-activitystream-filter"),this.loading=!1,this.loadEnd=!1,this.loadPage=1,this.loadIds=[],this.loadLimit=+peepsodata.activity_limit_below_fold;t=+peepsodata.loadmore_enable,t=peepso.isMobile()?1===t||2===t:1===t||3===t;this.loadButtonEnabled=t,this.loadButtonRepeat=this.loadButtonEnabled?+peepsodata.loadmore_repeat:0,this.loadButtonTemplate=e.template_load_more,this.isPermalink=+e.is_permalink,this.hideFromGuest=+e.hide_from_guest,this.loadLimit=0<this.loadLimit?this.loadLimit:3,n.proxy(function(t){var e,i,s;t&&(t="core_"+t,e=n("[id=peepso_stream_id]"),i=(s=this.$filters.filter("[data-id=peepso_stream_id]")).find('[data-option-value="'+t+'"]'),s=s.find(".ps-js-dropdown-toggle"),e.val()!==t&&i.length&&(e.val(t),s.find("span").text(i.find("span").text()),s.find(".ps-js-icon").attr("class",i.find(".ps-js-icon").attr("class"))))},this)(window.location.hash.slice(1)),this.$filterNotice=n("#ps-stream__filters-warning"),this.$filterNotice.length&&this.$filterNotice.data("html",this.$filterNotice.html().trim()),this.filterNoticeMap={},this.$filters.filter("[data-id=peepso_stream_id]").find("[data-option-value]").each(n.proxy(function(t,e){var i=n(e),e=i.data("option-value"),i=i.data("option-label-warning");this.filterNoticeMap[e]=i},this)),this.streamData={},n("[id^=peepso_stream_]").each(n.proxy(function(t,e){var i=e.id.replace(/^peepso_/,""),e=e.value;this.streamData[i]=e,"stream_id"===i&&(a||"core_scheduled"!==e?this.allowHideMyPosts(!0):this.allowHideMyPosts(!1))},this)),n(document).on("peepso_login_shown",function(){this.$loading.hide()}),this.$filters.on("click",".ps-js-dropdown-toggle",n.proxy(this.onFilterToggle,this)),this.$filters.on("click","[data-option-value]",n.proxy(this.onFilterSelect,this)),this.$filters.on("click",".ps-js-cancel",n.proxy(this.onFilterCancel,this)),this.$filters.on("click",".ps-js-apply",n.proxy(this.onFilterApply,this)),this.$filters.on("click","[type=text]",n.proxy(this.onFilterFocus,this)),this.$filters.on("keyup","[type=text]",n.proxy(this.onFilterKeyup,this)),this.$filters.on("click",".ps-js-search",n.proxy(this.onFilterSearch,this)),this.loadEverything="#everything"===window.location.hash,this.loadEverything&&(confirm("Are you sure want to load every post?")||(this.loadEverything=!1));var i=n("#ps-activitystream-search");this.search(i.eq(0).val()),peepso.observer.addAction("peepso_stream_reset",n.proxy(function(){this.search(i.eq(0).val())},this)),peepso.observer.addFilter("post_saved_notice",n.proxy(function(t){return"core_saved"===this.streamData.stream_id&&(t=!1),t},this),10,1)},search:function(t){var e,i;t=n.trim(t||""),this.searchKeyword=t,this.searchMode="exact",this.reset(),(e=n(".ps-js-activitystream-filter").filter("[data-id=peepso_search]").find(".ps-js-dropdown-toggle").find("span")).length&&(t?(i=e.data("keyword"),i+=t+'<i class="ps-posts__filter-remove gcis gci-times-circle"></i>',e.one("click","i",n.proxy(function(t){n("#ps-activitystream-search").val(""),this.search("")},this))):i=e.data("empty"),e.html(i))},autoload:function(e){if(e===this._token&&!this.loading)return!r&&this.hideFromGuest?(this.$loading.hide(),!1):void(this.shouldLoad()?(this.loading=!0,this.load(e).done(n.proxy(function(){this.loading=!1,this.isPermalink||this.loadEnd||this.autoload(e)},this))):this.loadButtonEnabled&&!this.$loadButton?(this.$loadButton=n(this.loadButtonTemplate).insertAfter(this.$el),this.$loadButton.one("click",n.proxy(function(t){n(t.currentTarget).remove(),this.autoload(e)},this))):this._onScrollEnabled||(this._onScrollEnabled=!0,n(window).on(i,e,n.proxy(this.onScroll,this))))},shouldLoad:function(){var t,e=this.$el.children(".ps-js-activity");return!this.loadEnd&&(!e.length||(!!this.loadEverything||(this.loadButtonEnabled&&this.loadButtonRepeat?e.length%this.loadButtonRepeat!=0||!!this.$loadButton&&(delete this.$loadButton,!0):!!(t=e.slice(0-this.loadLimit).eq(0)).length&&(e=this.loadButtonEnabled&&!this.$loadButton?t.eq(0).offset():t[0].getBoundingClientRect(),t=window.innerHeight||document.documentElement.clientHeight,e.top<t))))},load:function(s){var o=this,t=peepso.disableAuth().disableError(),a=_.extend({uid:r,user_id:d,post_id:l,context:h,page:this.loadPage,search:this.searchKeyword||void 0,search_mode:this.searchKeyword&&this.searchMode||void 0,pinned:1===this.loadPage?1:void 0},this.streamData||{});return a=peepso.observer.applyFilters("show_more_posts",a),n.Deferred(function(i){o.$loading.show(),t.postJson("activity.show_posts_per_page",a,function(t){var e;s===o._token&&(o.$loading.hide(),0<t.data.found_posts?((e=+t.data.act_id)?-1===o.loadIds.indexOf(e)&&(o.loadIds.push(e),o.render(t.data.posts)):o.render(t.data.posts),o.loadPage++):o.loadEnd=!0,o.loadEnd&&(1<a.page?((t=peepso.observer.applyFilters("activitystream_pending_html",""))&&o.render(t),o.$noMorePosts.show()):(o.searchKeyword?o.$noPostsMatch:o.$noPosts).show()),i.resolve())})})},reset:function(){this.loading=!1,this.loadEnd=!1,this.loadPage=1,this.loadIds=[],this._onScrollEnabled=!1,n(window).off(i),this.$loadButton&&(this.$loadButton.remove(),this.$loadButton=void 0),this.$el.empty().hide(),this.$recent.empty(),this.$noMorePosts.hide(),this.$noPosts.hide(),this.$noPostsMatch.hide();var t=this.filterNoticeMap[this.streamData.stream_id];t?(this.$filterNotice.html(this.$filterNotice.data("html").replace("%s",t)),this.$filterNotice.show()):this.$filterNotice.hide(),this._token=(new Date).getTime(),this.autoload(this._token)},render:function(t){t=t.replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"');var e=n(t),s=this.searchKeyword,o=this.searchMode;(e=peepso.observer.applyFilters("peepso_activity",e)).find(".ps-js-activity-content, .ps-comment-item, .ps-stream-quote").each(function(){var t=n(this),e=t.html(),e=peepso.observer.applyFilters("peepso_activity_content",e);t.html(e)}),s&&e.find(".ps-js-activity-content").each(function(){var t=n(this),e=t.html(),i=[s];"any"===o&&(i=_.filter(s.split(" "),function(t){return t})),i=_.map(i,function(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}),i=RegExp("("+i.join("|")+")(?![^<>]+>)","ig"),e=e.replace(i,'<span class="ps-text--highlight">$1</span>'),t.html(e)}),this.$el.is(":hidden")&&this.$el.show();try{e.appendTo(this.$el),e.each(function(){peepso.hooks.doAction("post_added",this)})}catch(t){}e.hide().fadeIn(1e3,function(){n(document).trigger("ps_activitystream_loaded"),peepso.observer.doAction("post_loaded",this),t.match(/\sdata-instgrm-permalink/)&&setTimeout(function(){try{window.instgrm.Embeds.process()}catch(t){}},1e3)})},allowHideMyPosts:function(t){var e=this.$filters.filter("[data-id=peepso_stream_filter_show_my_posts]"),i=e.find(".ps-js-dropdown-toggle");t?i.removeAttr("disabled"):(i.attr("disabled","disabled"),n("#"+e.data("id")).val(1),(e=e.find("[data-option-value]")).find("[type=radio][value=0]")[0].checked=!1,e.find("[type=radio][value=1]")[0].checked=!0,e=e.filter("[data-option-value=1]"),i.find("span").text(e.find("span").text()),i.find('[class*="ps-icon-"]').attr("class",e.find('[class*="ps-icon-"]').attr("class")))},onScroll:_.throttle(function(t){t=t.data;this.autoload(t)},1),onFilterToggle:_.debounce(function(t){var e,i=n(t.currentTarget).closest(".ps-js-activitystream-filter"),t=i.data("id").replace(/^peepso_/,""),t=this.streamData[t];i.is(":visible")&&(e=i.find("[type=radio]").filter('[value="'+t+'"]')).length&&(e[0].checked=!0)},1),onFilterSelect:function(t){var e=n(t.currentTarget).find("[type=radio]");t.preventDefault(),t.stopPropagation(),_.defer(function(){e[0].checked=!0})},onFilterCancel:function(t){n(t.currentTarget).closest(".ps-js-activitystream-filter").find(".ps-js-dropdown-toggle").focus()},onFilterApply:function(t){var e=n(t.currentTarget).closest(".ps-js-activitystream-filter"),i=e.find(".ps-js-dropdown-toggle"),s=n("#"+e.data("id")),o=e.find("[type=radio]:checked").closest("[data-option-value]"),t=o.data("optionValue"),e=e.data("id").replace(/^peepso_/,"");s.val(t),this.streamData[e]=t,i.find("span").text(o.find("span").text()),i.find(".ps-js-icon").attr("class",o.find(".ps-js-icon").attr("class")),i.focus(),"stream_id"===e&&(a||"core_scheduled"!==t?this.allowHideMyPosts(!0):this.allowHideMyPosts(!1)),this.reset()},onFilterFocus:function(t){t.stopPropagation()},onFilterKeyup:function(t){t.stopPropagation(),13===t.which&&n(t.currentTarget).closest(".ps-js-activitystream-filter").find(".ps-js-search").click()},onFilterSearch:function(t){var e=n(t.currentTarget).closest(".ps-js-activitystream-filter"),i=e.find(".ps-js-dropdown-toggle"),s=n("#"+e.data("id")),o=e.find("[type=radio]:checked").closest("[data-option-value]"),t=e.find("[type=text]"),o=o.data("optionValue"),e=(e.data("id").replace(/^peepso_/,""),t.val().trim()),t=i.find("span").data(e?"keyword":"empty");s.val(o),this.searchKeyword=e,this.searchMode=o,t=e?(t=i.find("span").data("keyword"))+e+'<i class="ps-posts__filter-remove gcis gci-times-circle"></i>':i.find("span").data("empty"),i.find("span").html(t).off("click","i").one("click","i",n.proxy(function(t){var e=n(t.target).closest(".ps-js-dropdown-toggle"),i=e.closest(".ps-js-activitystream-filter"),s=i.find("[type=text]"),i=n("#"+i.data("id"));t.stopPropagation(),s.val(""),i.val(""),e.find("span").html(e.find("span").data("empty")),this.searchKeyword="",this.searchMode="",this.reset()},this)),i.focus(),this.reset()}}));jQuery(function(t){var e=t("#ps-activitystream");e.length&&(t=peepsodata&&peepsodata.activity||{},new s(e[0],t))})}((window,jQuery));